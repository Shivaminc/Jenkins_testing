pipeline {
    agent any

    environment {
        PHP_VERSION = '7.4'
        DEPLOY_PATH = '/var/www/html/'
    }

    stages {
        stage('Static Analysis') {
            steps {
                echo 'Run the static analysis to the code'
            }
        }
        stage('Compile') {
            steps {
                echo 'Compile the source code'
            }
        }
        stage('Security Check') {
            steps {
                echo 'Run the security check against the application'
            }
        }
        stage('Run Unit Tests') {
            steps {
                echo 'Run unit tests from the source code'
            }
        }
        stage('Run Integration Tests') {
            steps {
                echo 'Run only crucial integration tests from the source code'
            }
        }
        stage('Publish Artifacts') {
            steps {
                echo 'Save the assemblies generated from the compilation'
            }
        }
        stage('Deploy') {
            steps {
                script {
                    // Copy files to the deployment directory
                    sh "rsync -avz --exclude='vendor' --exclude='.git' . ${DEPLOY_PATH}"
                    // Install production dependencies
                    sh "cd ${DEPLOY_PATH} && php composer.phar install --no-dev"
                    // Restart the web server
                    sh 'sudo systemctl restart apache2' // or restart nginx
                }
            }
        }
    }

    post {
        always {
            echo 'Pipeline completed'
        }
        success {
            echo 'Build and deployment succeeded!'
        }
        failure {
            echo 'Build or deployment failed!'
        }
    }
}
